#### **基本流程逻辑**

1. 调用所用sdk中的方法创建rtc对象
2. 创建完成后调用方法进入房间
3. 进入房间开启摄像头、麦克风
4. 调用相应方法监听远端视频流的进入
5. 接收到所有视频流后调用相应方法播放远端视频



#### 详细流程（以腾讯trtc为例）

**创建对象**

```javascript
const trtc = TRTC.create();
```



**进入房间**

在创建完rtc对象后，调用进入房间的方法时，往往需要携带一些必要参数：

调用 [trtc.enterRoom()](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/TRTC.html#enterRoom) 进入房间。通常在`开始通话`按钮的点击回调里进行调用。 关键参数：

- `scene`: 实时音视频通话模式，设置为 'rtc'。
- `sdkAppId`: 您在腾讯云创建的音视频应用的 sdkAppId。
- `userId`: 用户 ID，由您指定。
- `userSig`: 用户签名，参考[获取临时 userSig](https://console.cloud.tencent.com/trtc/usersigtool)，或者部署 [userSig 签发服务](https://cloud.tencent.com/document/product/647/17275?from_cn_redirect=1#formal)。
- `roomId`：房间 ID，由您指定，通常是生成唯一的房间ID。 更详细的参数说明参考接口文档 [trtc.enterRoom()](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/TRTC.html#enterRoom)。

```javascript
try {
  await trtc.enterRoom({ roomId: 8888, scene:'rtc', sdkAppId, userId, userSig });
  console.log('进房成功');
} catch (error) {
  console.error('进房失败 ' + error);
}

```



**开启摄像头，麦克风**

进入房间后使用 [trtc.startLocalVideo()](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/TRTC.html#startLocalVideo) 方法开启摄像头，并发布到房间。

```javascript
// 为了预览摄像头画面，您需在 DOM 中放置一个 HTMLElement，可以是一个 div 标签，假设其 id 为 local-video。
const view = 'local-video';
await trtc.startLocalVideo({ view });
```

使用 [trtc.startLocalAudio()](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/TRTC.html#startLocalAudio) 方法开启麦克风，并发布到房间。

```javascript
await trtc.startLocalAudio();
```



**播放远端音视频**

默认情况下，SDK 会自动播放远端音频，您无需调用 API 来播放远端音频。

- 需要注意的是：如果用户在进房前没有与页面产生过交互，自动播放音频可能会因为【浏览器的自动播放策略限制】而失败，您需参考[自动播放受限处理建议](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/tutorial-21-advanced-auto-play-policy.html)进行处理。

- 若您不希望 SDK 自动播放音频，您可以在 [trtc.enterRoom()](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/TRTC.html#enterRoom) 时设置 receiveMode = TRTC.TYPE.RECEIVE_MODE_MANUAL 关闭自动播放音频。

- 监听 [TRTC.EVENT.REMOTE_AUDIO_AVAILABLE](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/module-EVENT.html#.REMOTE_AUDIO_AVAILABLE) 事件，记录有远端音频的 userId，在需要播放音频时，调用 [trtc.muteRemoteAudio(userId, false)](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/TRTC.html#muteRemoteAudio) 方法。

  

在进房前监听 [TRTC.EVENT.REMOTE_VIDEO_AVAILABLE](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/module-EVENT.html#.REMOTE_VIDEO_AVAILABLE) 事件，在收到该事件时，通过 [trtc.startRemoteVideo()](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/TRTC.html#startRemoteVideo) 播放远端视频流。

```javascript
trtc.on(TRTC.EVENT.REMOTE_VIDEO_AVAILABLE, ({ userId, streamType }) => {
  // 为了播放视频画面，您需在 DOM 中放置一个 HTMLElement，可以是一个 div 标签，假设其 id 为 `${userId}_${streamType}`
  const view = `${userId}_${streamType}`;
  trtc.startRemoteVideo({ userId, streamType, view });
});
```



**退出房间**

调用 [trtc.exitRoom()](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/TRTC.html#exitRoom) 方法退出房间，结束音视频通话。

```javascript
await trtc.exitRoom(); 
// 退房成功后，若后续无需使用 trtc 实例，则可以调用 trtc.destroy 方法销毁实例，及时释放相关资源。销毁后的 trtc 实例无法继续使用，需要重新创建新的实例。
trtc.destroy();
```

**处理被踢**

除了用户主动退出房间之外，用户也有可能因为如下原因被踢出房间，此时 SDK 会抛出 [KICKED_OUT](https://web.sdk.qcloud.com/trtc/webrtc/v5/doc/zh-cn/module-EVENT.html#.KICKED_OUT) 事件，这时不需要调用 `trtc.exitRoom()` 退房，SDK 自动进入退房状态。

1. `kick`：两个相同 userId 的用户进入相同房间，前一个进房的用户会被踢出。同名用户同时进入同一房间是不允许的行为，可能会导致双方音视频通话异常，应避免出现这种情况。
2. `banned`：通过服务端的 [RemoveUser](https://cloud.tencent.com/document/api/647/40496) | [RemoveUserByStrRoomId](https://cloud.tencent.com/document/api/647/50426) 接口将某个用户踢出某个 TRTC 房间，该用户会收到被踢事件，reason 为 `banned` 。
3. `room-disband`：通过服务端的 [DismissRoom](https://cloud.tencent.com/document/api/647/50089) | [DismissRoomByStrRoomId](https://cloud.tencent.com/document/api/647/37088)接口将某个 TRTC 房间解散，解散房间之后，该房间的所有用户都会收到被踢事件，reason 为 `room-disband`。

```javascript
trtc.on(TRTC.EVENT.KICKED_OUT, error => {
  console.error(`kicked out, reason:${error.reason}, message:${error.message}`);
  // error.reason 有以下几种情况
  // 'kick' 由于相同 userId 进相同房间，导致先进入的用户被踢。
  // 'banned' 被管理员移出房间
  // 'room-disband' 管理员解散了房间
});
```

