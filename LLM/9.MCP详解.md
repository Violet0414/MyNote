### Model Context Protocol (模型上下文协议)

- #### 一、MCP 是什么？

  **Model Context Protocol (MCP)** 是一个**开放标准协议**，旨在标准化大型语言模型（LLM）与外部数据源、工具和服务之间的交互方式。它由**Anthropic**主导开发，但作为一个开放标准，得到了多家公司的支持。

  #### 核心理念

  "为LLM构建一个可插拔的、标准化的工具生态系统"，让模型能够安全、可靠地访问外部功能和数据。

  #### 二、为什么需要 MCP？

  #### 现有问题

  1. **碎片化**：每个LLM平台（OpenAI GPTs、Claude、LangChain等）都有自己的工具集成方式
  2. **重复开发**：相同的功能需要为不同平台重复实现
  3. **安全问题**：缺乏统一的安全模型和权限控制
  4. **部署复杂**：工具部署和维护成本高

  #### MCP 的解决方案

  - **统一接口**：一次开发，处处运行
  - **安全沙箱**：明确的权限边界
  - **易于扩展**：模块化设计

  #### 三、核心架构

  #### 三个关键组件

  ```reStructuredText
  ┌─────────────────┐     ┌─────────────────┐       ┌─────────────────┐
  │     主机         │   	 │     MCP协议     │       │ 服务器           │
  │   (Host)        │◀──▶│   (Protocol)     │◀──▶ │ (Server)        │
  │                 │     │                 │      │                 │
  │ • Claude Desktop│     │• JSON-RPC       │      │ • 文件系统        │
  │ • Cursor        │     │ • SSE/传输层     │      │ • 数据库连接      │
  │ • 其他LLM应用  	  │    │ • 标准化消息格式   │      │ • API网关        │
  └─────────────────┘     └─────────────────┘      └─────────────────┘
  ```

  

  #### 1. **主机 (Host)**

  运行LLM的客户端应用程序，负责：

  - 管理LLM会话
  - 加载和运行MCP服务器
  - 处理用户交互
  - 提供用户界面

  **示例主机**：

  - Claude Desktop
  - Cursor IDE
  - Windsurf 编辑器
  - 其他支持MCP的IDE和工具

  ### 2. **服务器 (Server)**

  提供特定功能的独立进程，负责：

  - 暴露工具（Tools）和资源（Resources）
  - 执行具体的操作（读取文件、查询数据库等）
  - 管理数据源连接

  **服务器类型示例**：

  ```bash
  # 文件系统服务器
  mcp-server-filesystem
  
  # PostgreSQL 数据库服务器
  mcp-server-postgres
  
  # GitHub 服务器
  mcp-server-github
  
  # 网页搜索服务器
  mcp-server-brave-search
  ```

  

  ### 3. **协议 (Protocol)**

  基于JSON-RPC 2.0的通信规范，支持：

  - **传输层**：stdio、SSE（Server-Sent Events）、HTTP
  - **消息格式**：标准化的请求/响应格式
  - **能力协商**：初始化时的特性协商

  ## 四、核心概念

  ### 1. **工具 (Tools)**

  LLM可以调用的函数，包含：

  - `name`：工具名称
  - `description`：工具描述（LLM据此决定是否使用）
  - `inputSchema`：输入参数JSON Schema

  **示例工具定义**：

  ```json
  {
    "name": "search_web",
    "description": "使用Brave搜索网络",
    "inputSchema": {
      "type": "object",
      "properties": {
        "query": {
          "type": "string",
          "description": "搜索关键词"
        },
        "count": {
          "type": "number",
          "description": "返回结果数量"
        }
      }
    }
  }
  ```

  

  ### 2. **资源 (Resources)**

  LLM可以读取的静态或动态数据源，包含：

  - `uri`：资源标识符（如 `file:///path/to/file`）
  - `mimeType`：内容类型
  - `name`：人类可读名称

  **资源类型**：

  - **静态资源**：文件、配置文件
  - **动态资源**：数据库查询结果、API响应
  - **可读资源**：LLM可以读取但不能修改

  ### 3. **提示词模板 (Prompts)**

  预定义的提示词片段，可以被LLM插入到对话中：

  ```json
  {
    "name": "code_review",
    "description": "代码审查模板",
    "arguments": [
      {
        "name": "language",
        "description": "编程语言"
      }
    ]
  }
  ```

  

  ## 五、通信流程

  ### 1. **初始化阶段**

  ```reStructuredText
  主机 → 服务器: initialize
  服务器 → 主机: 返回支持的能力（工具、资源、提示词）
  主机 ←→ 服务器: 能力协商完成
  ```

  

  #### 2. **工具调用流程**

  ```reStructuredText
  1. 用户输入问题
  2. LLM决定需要调用工具
  3. 主机发送 tools/call 请求到服务器
  4. 服务器执行实际操作
  5. 服务器返回结果
  6. 主机将结果提供给LLM
  7. LLM生成最终回答
  ```

  

  #### 3. **资源访问流程**

  text

  复制下载

  ```reStructuredText
  1. LLM需要读取数据
  2. 主机列出可用资源 (resources/list)
  3. 主机读取特定资源 (resources/read)
  4. 服务器返回资源内容
  5. LLM使用内容生成回答
  ```

  

  #### 六、实际示例

  #### 配置文件示例 (`claude_desktop_config.json`)

  ```json
  {
    "mcpServers": {
      "filesystem": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-filesystem", "/Users/me/projects"]
      },
      "postgres": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-postgres"],
        "env": {
          "POSTGRES_URL": "postgresql://user:pass@localhost:5432/mydb"
        }
      },
      "websearch": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-brave-search"],
        "env": {
          "BRAVE_API_KEY": "your-api-key"
        }
      }
    }
  }
  ```

  

  #### 工具调用示例

  ```javascript
  // 假设用户问："查看我的项目目录并搜索最新的日志"
  // MCP服务器处理流程：
  
  // 1. 文件系统服务器列出目录
  {
    "method": "tools/call",
    "params": {
      "name": "list_directory",
      "arguments": {
        "path": "/Users/me/projects"
      }
    }
  }
  
  // 2. 在某个日志文件中搜索
  {
    "method": "tools/call", 
    "params": {
      "name": "search_in_file",
      "arguments": {
        "filepath": "/Users/me/projects/app/logs/error.log",
        "pattern": "ERROR.*2024"
      }
    }
  }
  ```

  

  #### 七、安全模型

  #### 1. **权限隔离**

  - 每个服务器在独立进程中运行
  - 最小权限原则：服务器只能访问明确授权的资源
  - 主机控制哪些服务器可以被加载

  #### 2. **沙箱环境**

  - 服务器无法直接访问主机文件系统（除非明确配置）
  - 网络访问受限
  - 资源访问通过明确接口

  #### 3. **用户控制**

  - 用户明确授权每个服务器的权限
  - 配置透明：所有连接都在配置文件中明确列出
  - 可以随时禁用或移除服务器

  #### 八、与现有方案对比

  | 特性         | MCP          | OpenAI Functions | LangChain Tools |
  | :----------- | :----------- | :--------------- | :-------------- |
  | **标准化**   | 行业开放标准 | 厂商特定         | 框架特定        |
  | **可移植性** | ⭐⭐⭐⭐⭐        | ⭐⭐               | ⭐⭐⭐             |
  | **安全性**   | 沙箱隔离     | 应用层控制       | 依赖实现        |
  | **部署**     | 本地/远程    | 云API            | 代码集成        |
  | **学习曲线** | 中等         | 简单             | 较陡            |

  #### 九、生态系统

  #### 官方和社区服务器

  1. **数据源**：
     - 文件系统
     - PostgreSQL / MySQL
     - SQLite
     - Notion
     - Google Drive
  2. **开发工具**：
     - GitHub / GitLab
     - JIRA / Linear
     - Docker
     - Kubernetes
  3. **网络服务**：
     - Brave 搜索
     - 天气预报
     - 金融市场数据
  4. **生产力工具**：
     - Slack
     - Gmail
     - 日历

  ### 开发工具

  - **MCP Inspector**：调试和测试MCP服务器
  - **SDK**：TypeScript/Python/Go 等语言的开发套件
  - **模板仓库**：快速创建自定义服务器